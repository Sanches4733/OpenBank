---
title: "Задание банка Открытие"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
library(dplyr);library(tidyr);library(readxl);library(readr);library(ggplot2);
library(knitr);library(Rmisc);
```
# Подготовка данных
Для начала считаем данные из файла и взглянем на них.
```{r}
od <- read_excel("OpenRisk.xlsx", 
                col_names = c("Bank","Operation type",paste(rep("M",24),1:24,sep = "")),
                skip = 2)
od
```
Такую таблицу, наверное, удобно просматривать глазами, но с ней точно неудобно
работать в программе, так как она не отвечает основным принципам *чистых данных*.
Поэтому приведём её к такому виду: в каждом ряду у нас будут месячные наблюдения
по всем банкам.
```{r}
od <- od %>%
        gather(Month, number, M1:M24) %>%
        mutate (Bank = rep(LETTERS[1:5],each = 3,times = 24)) %>%
        spread(`Operation type`, number) %>%
        mutate(Month = parse_number(Month)) %>%
        arrange(Bank,Month) %>%
        select (1,2,Requests = 4,Approval = 5,Issues = 3)
od
```
Данные отсортированы по месяцам внутри каждого отдельного банка. В конце таблицы
будут данные за последние месяцы 5 банка, который мы обозначили за **E**.
```{r}
tail(od)
```
Тут же мы видим, что некоторые данные в таблице отсутствуют. Всего строк с пропущенными
значениями в файле `r sum(!complete.cases(od))`. Это не так много, поэтому взглянем на
них.
```{r}
od[!complete.cases(od),]
```
Примечательно, что от банков **D** и **E** нет информации за первые месяцы  - возможно,
они недавно открылись. Более примечательно, что от банка **E** нет информации за последние месяцы.
Возникает предположение, что это отделение закрылось. Посмотрим, есть ли какие-то очевидные поводы для
такого решения.

Для начала добавим в нашу таблицу столбцы с абсолютным количеством одобренных заявок,
а так же "уровень согласия" - то есть процент одобренных заявок, на которые согласились клиенты.
```{r}
od <- od %>%
        mutate(Approved = Requests*Approval,Accepted = Issues/Approved) %>%
        select(c(1,2,3,6,5,4,7))
od
```


Построим графики, отражающие количество заявок, одобренных заявок и выданных кредитов в каждом банке.
```{r}
grequests <- ggplot(od, aes(x=Month, y=Requests, colour=Bank)) +
    geom_line() +
    ggtitle("Заявки")
gapproved <- ggplot(od, aes(x=Month, y=Approved, colour=Bank)) +
    geom_line() +
    ggtitle("Одобрено")
gissues <- ggplot(od, aes(x=Month, y=Issues, colour=Bank)) +
    geom_line() +
    ggtitle("Выдано")
multiplot(grequests,gapproved,gissues,cols = 2)
```
Действительно, в банк E долгое время подавалось наименьшее количество заявок, почти
всегда там одобрялось наименьшее количество заявок и всегда там выпускалось наименьшее 
количество кредитов.
Возможно, он находился в районе с малым числом потенциальных клиентов. 
